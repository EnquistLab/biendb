-- --------------------------------------------------------
-- Insert raw data from traits_raw into agg_traits
-- --------------------------------------------------------

set search_path to :dev_schema;

INSERT INTO agg_traits (
id,
traits_id,
bien_taxonomy_id,
fk_tnrs_id,
verbatim_family,
verbatim_scientific_name,
name_submitted,
family_matched,
name_matched,
name_matched_author,
higher_plant_group,
tnrs_warning,
matched_taxonomic_status,
scrubbed_taxonomic_status,
scrubbed_family,
scrubbed_genus,
scrubbed_specific_epithet,
scrubbed_species_binomial,
scrubbed_taxon_name_no_author,
scrubbed_taxon_canonical,
scrubbed_author,
scrubbed_taxon_name_with_author,
scrubbed_species_binomial_with_morphospecies,
trait_name,
trait_value,
unit,
method,
region,
country_verbatim,
state_province_verbatim,
county_verbatim,
country,
state_province,
lower_political,
is_centroid,
is_in_country,
is_in_state_province,
is_in_county,
locality_description,
latlong_verbatim,
latitude,
min_latitude,
max_latitude,
longitude,
min_longitude,
max_longitude,
is_geovalid,
is_new_world,
elevation_verbatim,
elevation_m,
elevation_min_m,
elevation_max_m,
source,
url_source,
source_citation,
source_id,
visiting_date,
visiting_date_accuracy,
reference_number,
access,
project_pi,
project_pi_contact,
observation,
authorship,
authorship_contact,
citation_bibtex,
plant_trait_files,
is_experiment,
observation_context,
observation_date,
observation_date_accuracy,
source_locality,
is_individual_trait,
is_species_trait,
is_trait_value_valid,
temporary_taxonobservation_id,
taxonobservation_id,
is_individual_measurement
)
SELECT
cast(id as integer),
cast(traits_id as integer),
NULL,
NULL,
verbatim_family,
verbatim_scientific_name,
case
when verbatim_family like '%aceae' or verbatim_family in ('Compositae','Palmae','Gramineae','Cruciferae','Labiatae','Leguminosae','Guttiferae', 'Umbelliferae') then trim(concat_ws(' ',
verbatim_family, verbatim_scientific_name))
else trim(verbatim_scientific_name)
end,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
trait_name,
trait_value,
unit,
"method",
region,
country,
state_province,
lower_political,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
NULL,
locality_description,
trim(concat_ws(' ',latitude, longitude)),
latitude,
min_latitude,
max_latitude,
longitude,
min_longitude,
max_longitude,
NULL,
NULL,
elevation_m,
case
when elevation_m='NA' or elevation_m=null or trim(elevation_m)='' THEN null
WHEN elevation_m LIKE '%-%' THEN CAST( 
( (split_part(elevation_m,'-',1)::integer + split_part(elevation_m,'-',2)::integer) / 2 ) 
AS numeric(5,1) )
else cast(elevation_m as numeric(5,1))
end,
case
WHEN elevation_m LIKE '%-%' THEN split_part(elevation_m,'-',1)::integer
else NULL
end,
case
WHEN elevation_m LIKE '%-%' THEN split_part(elevation_m,'-',2)::integer
else NULL
end,
"source",
url_source,
source_citation,
source_id,
visiting_date,
'day',
reference_number,
access,
project_pi,
project_pi_contact,
observation,
authorship,
authorship_contact,
citation_bibtex,
plant_trait_files,
is_experiment,
observation_context,
observation_date,
NULL,
source_locality,
is_individual_trait,
is_species_trait,
is_trait_value_valid,
temporary_taxonobservation_id,
taxonobservation_id,
is_individual_measurement
FROM traits_raw
;

-- Now index the field needed for next step

-- Add indexes needed for the following operations to agg_traits
CREATE INDEX agg_traits_id_idx ON agg_traits (id);
CREATE INDEX agg_traits_name_submitted_idx ON agg_traits (name_submitted);


